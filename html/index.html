<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Module Control UI</title>
<style>
  :root{
--txcol: #00e89d;
--bckcol: #333;
--bckbx: rgb(27, 27, 27);
}

body {
font-family:monospace;
color: var(--txcol);
padding-left: 5vw;
padding-right: 5vw;
background-color: rgb(27, 27, 27);
font-size: x-large;}

.module {
border: 2px solid var(--txcol);
background-color: var(--bckbx);
width: 800px;
padding: 1vh;
margin: 2vh auto 2vh auto;
display: inline-block;
vertical-align: top; }

.module h3 { margin-top: 0; }

button {
    border: 2px solid var(--txcol);
    background-color: var(--bckbx);
    color: var(--txcol);
}
button:active{
    background-color: var(--txcol);
    color: var(--bckbx);
}

button:hover{
    background-color: var(--bckcol);
}
input{
    background-color: var(--bckcol);
    color: #00e89d;
    font-weight: lighter;
    font-size: 2vh;
}

.display { margin-top: 5px;
font-weight: bold; }

.global-controls { 
margin: 3vh auto 3vh auto;
padding: 1vh;
border: 2px solid var(--txcol);
}

.global-controls button{
    width: 30vw;
    height: 5vh;
    font-size: 2vh;
    padding: 1vw 1vh 1vw 1vh;
    margin: 0.5vh;

}

.global-controls input{
    width: 35vw;
    height: auto;
}

#title{
  width: 100%;
  overflow-x: auto;     /* scroll if it overflows horizontally */
  text-align: center; 
}
#art{
  font-family: monospace;
  font-size: clamp(8px, 2vw, 20px); /* responsive font size */
  line-height: 1.2;
  white-space: pre;     /* preserve spacing */
  margin: 0 auto;
  display: inline-block
}
#motion{
    margin: auto;
    text-align: center;

}

.m{
    margin: 2vw;
    font-size: 3vh;
    padding: 1vw 1vh 1vw 1vh;
}

.mval{
    margin: auto;
    text-align: center;
}

#info{ 
border: 2px solid var(--txcol);
display: block;
margin: 2vh auto 2vh auto;
padding: 1vh;
}

</style>
</head>
<body>
<div id="title"><pre id="art">
▗▖ ▗▖▗▄▄▄▖▗▖  ▗▖▗▄▄▄▖▗▖   ▗▄▄▄▖▗▖  ▗▖▗▖ ▗▖
▐▌▗▞▘  █  ▐▛▚▖▐▌▐▌   ▐▌     █  ▐▛▚▖▐▌▐▌▗▞▘
▐▛▚▖   █  ▐▌ ▝▜▌▐▛▀▀▘▐▌     █  ▐▌ ▝▜▌▐▛▚▖ 
▐▌ ▐▌▗▄█▄▖▐▌  ▐▌▐▙▄▄▖▐▙▄▄▖▗▄█▄▖▐▌  ▐▌▐▌ ▐▌
</pre>
</div>

<div id="info">
  Welcome on the Kinelink configuration page
  Setup per module parameters, or use Global Controls to set parameters
  on all connected modules at once.
  Use PANIC! button to stop all ongoing motion on all connected modules.
  <br><br>
  Developped by e-garbage for STRUCTURALS - 2025
</div>


<div class="global-controls">
  <h3>Global Controls</h3>
  <div>  
    <input type="number" id="global-speed" placeholder="Speed">
    <button onclick="globalSpeed()">Set Speed</button>
  </div>
  <div>
    <input type="number" id="global-accel" placeholder="Accel">
    <button onclick="globalAccel()">Set Accel</button>
  </div>
  <div id="motion" style="padding-top: 3vh;padding-bottom: 3vh;">
  <button style="color:red;font-weight: bold; border:2px solid red" onclick="panic()">PANIC!</button>
  <button onclick="globalHome()">Set Home All</button>
  </div>
</div>

<div id="modules-container"></div>

<script>
const API_BASE = "/api"; // through Apache proxy

let motordata = {};
let modules = [];

async function init() {
  const res = await fetch(`${API_BASE}/p/connected`);
  motordata = await res.json();   // store JSON globally
  const addr = Object.keys(motordata).map(Number);
  modules = addr.filter(a => a >= 10);
}
async function loadModules() {
  const m = await init();
  const container = document.getElementById("modules-container");
  container.innerHTML = "";
  modules.forEach(addr => {
    const moduleDiv = document.createElement("div");
    moduleDiv.className = "module";
    moduleDiv.id = `module-${addr}`;
    moduleDiv.innerHTML = `
      <h3>Module ${addr}</h3>
      <div id="motion">
        <button class="m" id="mleft" onclick="moveLeft(${addr})">◄</button>
        <button class="m" id="mstop" onclick="stop(${addr})">Stop</button>
        <button class="m" id="mright" onclick="moveRight(${addr})">►</button>
      </div>
      <div class="mval" >
        <input type="number" id="vel-${addr}" placeholder="current: ${motordata[addr].speed}">
      </div>
      <div id="motion">
      <button class="m" onclick="setHome(${addr})">Set Home</button>
      <button class="m" onclick="setMax(${addr})">Set Max</button>
      </div>
      <div style="margin:1vh;">
        <input type="number" id="goto-${addr}" placeholder="Position">
        <button onclick="gotoPosition(${addr})">Go To</button>
      </div>
      <div style="margin:1vh;">
        <input type="number" id="speed-${addr}" placeholder="current: ${motordata[addr].speed}">
        <button onclick="setSpeed(${addr})">Set Speed</button>
      </div>
      <div style="margin:1vh;">
        <input type="number" id="accel-${addr}" placeholder="current: ${motordata[addr].accel}">
        <button onclick="setAccel(${addr})">Set Accel</button>
      </div>
      <div class="display">Temperature: <span id="temp-${addr}">0</span>°C</div>
      <div class="display">Current Position: <span id="pos-${addr}">0</span></div>
      <div class="display">Max Position: <span id="maxpos-${addr}">0</span></div>
    `;
    container.appendChild(moduleDiv);
  });
  setInterval(updateStatus, 2000);
}

// Module commands
async function moveLeft(addr) {
  const vel = document.getElementById(`vel-${addr}`).value || 0;
  await fetch(`${API_BASE}/m/left?addr=${addr}&speed=${vel}`, { method: "GET" });
}
async function moveRight(addr) {
  const vel = document.getElementById(`vel-${addr}`).value || 0;
  await fetch(`${API_BASE}/m/right?addr=${addr}&speed=${vel}`, { method: "GET" });
}
async function stop(addr) {
  await fetch(`${API_BASE}/m/stop?addr=${addr}`, { method: "GET" });
}
async function setHome(addr) {
  await fetch(`${API_BASE}/m/setref?addr=${addr}`, { method: "GET" });
}
async function setMax(addr){
  const cpos = await fetch(`${API_BASE}/p/getpos?addr=${addr}`);
  const cposdata = await cpos.json();
  await fetch(`${API_BASE}/p/setmax?addr=${addr}&pos=${cposdata.reply[4]}`, {method: "GET"});
}
async function gotoPosition(addr) {
  const pos = document.getElementById(`goto-${addr}`).value || 0;
  await fetch(`${API_BASE}/m/gotopos?addr=${addr}&pos=${pos}`, { method: "GET" });
}
async function setSpeed(addr) {
  const speed = document.getElementById(`speed-${addr}`).value || 0;
  await fetch(`${API_BASE}/p/setspeed?addr=${addr}&speed=${speed}`, { method: "GET" });
}
async function setAccel(addr) {
  const accel = document.getElementById(`accel-${addr}`).value || 0;
  await fetch(`${API_BASE}/p/setaccel?addr=${addr}&accel=${accel}`, { method: "GET" });
}
async function panic(){
  await fetch(`${API_BASE}/p/panic`, {method:"GET"});
}

//Update temperature and current position
async function updateStatus() {
  init()
  for (const addr of modules){
    const tempRes = await fetch(`${API_BASE}/p/gettemp?addr=${addr}`);
    const temp = await tempRes.json();
    document.getElementById(`temp-${addr}`).textContent=temp.reply[4];
    const posRes = await fetch(`${API_BASE}/p/getpos?addr=${addr}`);
    const pos = await posRes.json();
    document.getElementById(`pos-${addr}`).textContent=pos.reply[4];
    document.getElementById(`maxpos-${addr}`).textContent=motordata[addr].maxpos;
  }
}
async function globalSpeed(){
  let value =null;
  value= document.getElementById("global-speed").value || 0;
  const promises = modules.map(addr=>{
    const url = `${API_BASE}/p/setspeed?addr=${addr}&speed=${value}`;
    return fetch(url, {method: "GET"});
  })
  await Promise.all (promises);
}
async function globalAccel(){
  let value = null;
  value = document.getElementById("global-accel").value || 0;
  const promises = modules.map (addr =>{
    const url =`${API_BASE}/p/setaccel?addr=${addr}&accel=${value}`;
    return fetch(url, {method: "GET"});
  })
  await Promise.all(promises);
}
async function globalHome() {
  const promises = modules.map(addr =>{
    const url = `${API_BASE}/m/setref?addr=${addr}`;
    return fetch(url, {method: "GET"});
  })
  await Promise.all(promises);
}

window.onload = loadModules();

</script>
</body>
</html>
